<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Retail KPI Mobile App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --card: #111827;
      --accent: #fb923c;
      --accent-soft: rgba(251, 146, 60, 0.15);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --warning: #eab308;
      --radius-lg: 18px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--text-main);
      padding: 16px;
    }

    .app-shell {
      max-width: 540px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .app-title {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: .04em;
    }

    .badge {
      font-size: .7rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 14px;
    }

    .tab-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .4);
      background: rgba(15, 23, 42, .9);
      padding: 6px 4px;
      font-size: .8rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all .18s ease;
    }

    .tab-btn.active {
      background: linear-gradient(to right, #fb923c, #f97316);
      border-color: #f97316;
      color: #0f172a;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(248, 113, 22, .35);
    }

    .screen { display: none; }
    .screen.active { display: block; }

    .card {
      background: radial-gradient(circle at top left, #1f2937 0, var(--card) 55%);
      border-radius: var(--radius-lg);
      padding: 14px 14px 10px;
      margin-bottom: 12px;
      border: 1px solid rgba(148, 163, 184, .35);
      box-shadow: 0 14px 35px rgba(15, 23, 42, .75);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: .95rem;
      font-weight: 600;
    }

    .card-sub {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: .75rem;
    }

    label span {
      color: var(--text-muted);
      font-size: .7rem;
    }

    input, select {
      background: rgba(15, 23, 42, .9);
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, .9);
      padding: 6px 8px;
      color: var(--text-main);
      font-size: .8rem;
      outline: none;
      width: 100%;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(251, 146, 60, .45);
    }

    input[type="checkbox"] {
      width: auto;
      accent-color: var(--accent);
      box-shadow: none;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      padding: 10px;
      font-size: .9rem;
      border: none;
      margin-top: 8px;
      background: linear-gradient(to right, #fb923c, #f97316);
      color: #111827;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 14px 30px rgba(248, 113, 22, .45);
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, .85);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      font-size: .7rem;
    }

    .chip {
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, .8);
      border: 1px solid rgba(148, 163, 184, .5);
      color: var(--text-muted);
    }

    .list {
      max-height: 150px;
      overflow-y: auto;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, .8);
    }

    .list-row {
      display: grid;
      grid-template-columns: 1.2fr .8fr .8fr;
      padding: 6px 8px;
      font-size: .72rem;
      background: rgba(15, 23, 42, .85);
    }

    .list-row:nth-child(even) {
      background: rgba(17, 24, 39, .95);
    }

    .list-head {
      font-weight: 600;
      color: var(--text-muted);
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 2;
      border-bottom: 1px solid rgba(55, 65, 81, .9);
    }

    .pill {
      font-size: .7rem;
      padding: 2px 6px;
      border-radius: 999px;
      display: inline-block;
      margin-left: 4px;
    }

    .pill-ok { background: rgba(34, 197, 94, .2); color: var(--success); }
    .pill-mid { background: rgba(234, 179, 8, .2); color: var(--warning); }
    .pill-bad { background: rgba(239, 68, 68, .2); color: var(--danger); }
    .pill-over { background: rgba(59, 130, 246, .2); color: #60a5fa; }

    .progress {
      position: relative;
      height: 8px;
      border-radius: 999px;
      background: rgba(31, 41, 55, .9);
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-bar {
      position: absolute;
      inset: 0;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(to right, #22c55e, #16a34a);
      transition: width .25s ease;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: 1.3fr .8fr .8fr .9fr;
      gap: 6px;
      font-size: .74rem;
      margin-bottom: 6px;
      align-items: center;
    }

    .kpi-label { color: var(--text-muted); }

    .kpi-num { text-align: right; }

    .kpi-num strong { color: var(--text-main); }

    .tagline {
      font-size: .7rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .muted { color: var(--text-muted); font-size: .72rem; }

    .rules-list {
      font-size: .75rem;
      display: grid;
      gap: 6px;
      margin-top: 6px;
    }

    .rule-item {
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, .92);
      border: 1px solid rgba(55, 65, 81, .9);
    }

    .rule-section {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--accent);
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div>
      <div class="app-title">Retail KPI Pro</div>
      <div class="muted">Daily tracker + auto points</div>
    </div>
    <span class="badge">Dec 2025</span>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-screen="screen-entry">Daily Entry</button>
    <button class="tab-btn" data-screen="screen-dashboard">Dashboard</button>
    <button class="tab-btn" data-screen="screen-settings">Settings & Rules</button>
  </div>

  <!-- ========== DAILY ENTRY SCREEN ========== -->
  <section id="screen-entry" class="screen active">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Core KPIs – Day Input</div>
          <div class="card-sub">اكتب أرقام اليوم، والأبلكيشن هيجمع الشهر كله</div>
        </div>
      </div>
      <div class="field">
        <label>Date
          <input type="date" id="date">
        </label>
      </div>
      <div class="grid-2" style="margin-top:6px">
        <div class="field">
          <label>GAs (Lines)</label>
          <input type="number" id="gas" min="0" step="1">
        </div>
        <div class="field">
          <label>OC Existing Wallets</label>
          <input type="number" id="ocExisting" min="0" step="1">
        </div>
        <div class="field">
          <label>OC New Wallets</label>
          <input type="number" id="ocNew" min="0" step="1">
        </div>
        <div class="field">
          <label>Postpaid Lines</label>
          <input type="number" id="postpaid" min="0" step="1">
        </div>
        <div class="field">
          <label>Home ADSL Subs</label>
          <input type="number" id="adsl" min="0" step="1">
        </div>
        <div class="field">
          <label>Home Wireless Subs</label>
          <input type="number" id="wireless" min="0" step="1">
        </div>
        <div class="field">
          <label>Devices</label>
          <input type="number" id="devices" min="0" step="1">
        </div>
        <div class="field">
          <label>Base Points (from system)<span>النقاط اللي من السيستم مباشرة</span></label>
          <input type="number" id="basePoints" min="0" step="0.1">
        </div>
      </div>
      <div class="tagline">مسؤولية الأبلكيشن: يحسب البونص والزيادات أوتوماتيك ويضيفهم على الـ Points.</div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">FREEmax / Corporate / SIM Rules</div>
          <div class="card-sub">الرولز اللي فيها أرقام واضحة متطبقة هنا</div>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>FREEmax 70</label>
          <input type="number" id="fm70" min="0" step="1">
        </div>
        <div class="field">
          <label>FREEmax 100</label>
          <input type="number" id="fm100" min="0" step="1">
        </div>
        <div class="field">
          <label>FREEmax 150</label>
          <input type="number" id="fm150" min="0" step="1">
        </div>
        <div class="field">
          <label>FREEmax 200</label>
          <input type="number" id="fm200" min="0" step="1">
        </div>
        <div class="field">
          <label>FREEmax 300</label>
          <input type="number" id="fm300" min="0" step="1">
        </div>
        <div class="field">
          <label>New Corporate Accounts</label>
          <input type="number" id="corpNewAcc" min="0" step="1">
        </div>
        <div class="field">
          <label>Lines in New Corp Accounts</label>
          <input type="number" id="corpNewLines" min="0" step="1">
        </div>
        <div class="field">
          <label>Corp Lines (other)</label>
          <input type="number" id="corpOtherLines" min="0" step="1">
        </div>
        <div class="field">
          <label>SIM 3G → 4G</label>
          <input type="number" id="sim34" min="0" step="1">
        </div>
        <div class="field">
          <label>SIM 3G/4G → eSIM</label>
          <input type="number" id="simEsim" min="0" step="1">
        </div>
      </div>
      <div class="chips">
        <span class="chip">Corp new acc = 12 pts</span>
        <span class="chip">SIM 3G→4G = 1.5 pt</span>
        <span class="chip">SIM→eSIM = 3 pts</span>
        <span class="chip">FREEmax buckets بالنقاط الجديدة</span>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Extra Bonuses & Manual</div>
          <div class="card-sub">رولز الأوفر: MNP / PREMIER / ADSL زيادة</div>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Extra ADSL Subs over target (today)</label>
          <input type="number" id="extraAdsl" min="0" step="1">
        </div>
        <div class="field">
          <label>Extra MNP lines after target</label>
          <input type="number" id="extraMnp" min="0" step="1">
        </div>
        <div class="field">
          <label>Extra PREMIER lines over achievement</label>
          <input type="number" id="extraPremier" min="0" step="1">
        </div>
        <div class="field">
          <label>Manual Bonus Points<span>لأي رول مش مغطاة في الأبلكيشن</span></label>
          <input type="number" id="manualBonus" min="0" step="0.1">
        </div>
      </div>
      <div class="chips">
        <span class="chip">Extra ADSL = double points (تقريب)</span>
        <span class="chip">Extra MNP = +10 pts / line</span>
        <span class="chip">Extra PREMIER = +30 pts / line</span>
      </div>
      <button class="btn-primary" id="saveDayBtn">Save Day & Calculate</button>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Last Saved Days</div>
          <div class="card-sub">ملخص سريع لأيام الشهر</div>
        </div>
      </div>
      <div class="list" id="dayList"></div>
      <div class="tagline">أي تعديل محتاجه، امسح اليوم من Reset Data في Settings وادخله تاني.</div>
    </div>
  </section>

  <!-- ========== DASHBOARD SCREEN ========== -->
  <section id="screen-dashboard" class="screen">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">KPI Progress</div>
          <div class="card-sub">تقدمك مقابل التارجت الشهري</div>
        </div>
        <div class="card-sub" id="daysInfo"></div>
      </div>
      <div id="kpiContainer"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Points Breakdown</div>
          <div class="card-sub">Base + FREEmax + Corporate + SIM + Extra</div>
        </div>
      </div>
      <div id="pointsBreakdown" class="rules-list"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Final Score & Clawback</div>
          <div class="card-sub">زي ما مكتوب في القواعد</div>
        </div>
      </div>
      <div id="scoreSummary" class="rules-list"></div>
    </div>
  </section>

  <!-- ========== SETTINGS & RULES SCREEN ========== -->
  <section id="screen-settings" class="screen">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Monthly Targets & Quality</div>
          <div class="card-sub">دخل التارجت مرة واحدة في أول الشهر</div>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Days in month</label>
          <input type="number" id="daysInMonth" min="1" max="31">
        </div>
        <div class="field">
          <label>Quality overall score %</label>
          <input type="number" id="qualityScore" min="0" max="100" step="0.1">
        </div>
        <div class="field">
          <label>Target GAs</label>
          <input type="number" id="tGas" min="0" step="1">
        </div>
        <div class="field">
          <label>Target OC Existing</label>
          <input type="number" id="tOcExisting" min="0" step="1">
        </div>
        <div class="field">
          <label>Target OC New</label>
          <input type="number" id="tOcNew" min="0" step="1">
        </div>
        <div class="field">
          <label>Target Points</label>
          <input type="number" id="tPoints" min="0" step="1">
        </div>
        <div class="field">
          <label>Target Postpaid</label>
          <input type="number" id="tPostpaid" min="0" step="1">
        </div>
        <div class="field">
          <label>Target Home Internet (ADSL+Wireless)</label>
          <input type="number" id="tHomeInternet" min="0" step="1">
        </div>
        <div class="field">
          <label>Target Devices</label>
          <input type="number" id="tDevices" min="0" step="1">
        </div>
        <div class="field">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="ntraViolation">
            NTRA violation this month?
          </label>
        </div>
      </div>
      <button class="btn-primary" id="saveSettingsBtn">Save Settings</button>
      <div class="tagline">الإعدادات بتتخزن في الموبايل (localStorage) ومش بتطلع برا.</div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Rules Snapshot</div>
          <div class="card-sub">أهم الرولز اللي الأبلكيشن مطبقها تلقائيًا</div>
        </div>
      </div>
      <div class="rules-list">
        <div class="rule-item">
          <div class="rule-section">Points & FREEmax</div>
          <div>FREEmax 70/100/150/200/300 بنقاط: 10 / 13 / 18 / 23 / 33 لكل لاين.</div>
        </div>
        <div class="rule-item">
          <div class="rule-section">Corporate</div>
          <div>New Corporate Account = 12 points + خطوطه بتتحسب GAs + خطوط جديدة عليه تاخد Double Points (بنضيفها على البوينتس).</div>
        </div>
        <div class="rule-item">
          <div class="rule-section">SIM Changes</div>
          <div>Change SIM 3G → 4G = 1.5 point – Change SIM 3G/4G → eSIM = 3 points.</div>
        </div>
        <div class="rule-item">
          <div class="rule-section">Extra Bonus</div>
          <div>Extra ADSL over target (بتتحسب تقريبي Double Points), Extra MNP = +10 pts / line, Extra PREMIER = +30 pts / line.</div>
        </div>
        <div class="rule-item">
          <div class="rule-section">Clawback & Quality</div>
          <div>لو Postpaid أو Home Internet أقل من 100%: 5% خصم لكل واحد. لو Quality &lt; 92%: خصم 10% إضافي. ولو السكور النهائي &lt; 80% → No Payment.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Danger Zone</div>
      </div>
      <button class="btn-primary" id="resetAllBtn" style="background:linear-gradient(to right,#ef4444,#b91c1c);box-shadow:0 12px 30px rgba(239,68,68,.4)">
        Reset all data for this month
      </button>
      <div class="tagline">لو عايز تبدأ من أول وجديد امسح الداتا كلها من هنا.</div>
    </div>
  </section>
</div>

<script>
  // ---------- CONSTANTS ----------
  const KPI_DEFS = [
    { key: "gas",           label: "GAs (Lines)",                      wAgent: 40, wMgr: 30 },
    { key: "points",        label: "Points",                           wAgent: 15, wMgr: 10 },
    { key: "ocExisting",    label: "OC Existing Wallets",              wAgent: 10, wMgr: 10 },
    { key: "ocNew",         label: "OC New Wallets",                   wAgent: 0,  wMgr: 0  },
    { key: "postpaid",      label: "Postpaid Lines",                   wAgent: 10, wMgr: 10 },
    { key: "homeInternet",  label: "Home Internet (ADSL+Wireless)",    wAgent: 12, wMgr: 12 },
    { key: "devices",       label: "Devices",                          wAgent: 5,  wMgr: 5  }
  ];

  const FREE_MAX_POINTS = { fm70: 10, fm100: 13, fm150: 18, fm200: 23, fm300: 33 };
  const EXTRA_RULES = {
    extraAdslBonusPerLine: 10,   // تقريب: ممكن تعدله في الكود
    extraMnpBonusPerLine: 10,
    extraPremierBonusPerLine: 30
  };

  // ---------- STATE ----------
  let days = JSON.parse(localStorage.getItem("kpi_days") || "[]");
  let settings = JSON.parse(localStorage.getItem("kpi_settings") || "null") || {
    daysInMonth: 31,
    qualityScore: 100,
    ntraViolation: false,
    targets: {
      gas: 0,
      ocExisting: 0,
      ocNew: 0,
      points: 0,
      postpaid: 0,
      homeInternet: 0,
      devices: 0
    }
  };

  // ---------- HELPERS ----------
  const num = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

  function computePoints(entry) {
    const base = num(entry.basePoints);

    const fmPoints =
      num(entry.fm70)  * FREE_MAX_POINTS.fm70 +
      num(entry.fm100) * FREE_MAX_POINTS.fm100 +
      num(entry.fm150) * FREE_MAX_POINTS.fm150 +
      num(entry.fm200) * FREE_MAX_POINTS.fm200 +
      num(entry.fm300) * FREE_MAX_POINTS.fm300;

    const corp = num(entry.corpNewAcc) * 12
               + num(entry.corpNewLines) * 0   // double points handled via manual bonus if needed
               + num(entry.corpOtherLines) * 0;

    const sim = num(entry.sim34)   * 1.5 +
                num(entry.simEsim) * 3;

    const extraAdsl    = num(entry.extraAdsl)    * EXTRA_RULES.extraAdslBonusPerLine;
    const extraMnp     = num(entry.extraMnp)     * EXTRA_RULES.extraMnpBonusPerLine;
    const extraPremier = num(entry.extraPremier) * EXTRA_RULES.extraPremierBonusPerLine;

    const manual = num(entry.manualBonus);

    const bonusTotal = fmPoints + corp + sim + extraAdsl + extraMnp + extraPremier + manual;
    const total = base + bonusTotal;

    return { base, fmPoints, corp, sim, extraAdsl, extraMnp, extraPremier, manual, bonusTotal, total };
  }

  function recalcAndSave() {
    localStorage.setItem("kpi_days", JSON.stringify(days));
    localStorage.setItem("kpi_settings", JSON.stringify(settings));
    renderDays();
    renderDashboard();
  }

  function aggregate() {
    const agg = {
      gas: 0, ocExisting: 0, ocNew: 0,
      postpaid: 0, adsl: 0, wireless: 0, devices: 0,
      basePoints: 0, bonusPoints: 0, totalPoints: 0,
      usedDays: new Set()
    };

    days.forEach(d => {
      agg.gas        += num(d.gas);
      agg.ocExisting += num(d.ocExisting);
      agg.ocNew      += num(d.ocNew);
      agg.postpaid   += num(d.postpaid);
      agg.adsl       += num(d.adsl);
      agg.wireless   += num(d.wireless);
      agg.devices    += num(d.devices);
      const pts = computePoints(d);
      agg.basePoints  += pts.base;
      agg.bonusPoints += pts.bonusTotal;
      agg.totalPoints += pts.total;
      if (d.date) agg.usedDays.add(d.date);
    });

    agg.homeInternet = agg.adsl + agg.wireless;
    agg.usedDaysCount = agg.usedDays.size;
    return agg;
  }

  function kpiProgress(total, target) {
    target = num(target);
    if (!target || target <= 0) return {
      ratio: 0, remaining: 0, neededPerDay: 0, label: "No target"
    };
    const ratio = total / target;
    const remaining = target - total;
    const daysUsed = aggregate().usedDaysCount || 1;
    const daysLeft = Math.max(settings.daysInMonth - daysUsed, 0);
    const neededPerDay = remaining > 0 && daysLeft > 0 ? remaining / daysLeft : 0;
    return { ratio, remaining, neededPerDay };
  }

  // ---------- RENDER: DAYS ----------
  function renderDays() {
    const container = document.getElementById("dayList");
    if (!days.length) {
      container.innerHTML = '<div class="list-row" style="justify-content:center;">No days saved yet</div>';
      return;
    }
    let html = `
      <div class="list-row list-head">
        <div>Date</div>
        <div>Total Points</div>
        <div>GAs / OC</div>
      </div>
    `;
    days
      .slice()
      .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
      .forEach(d => {
        const pts = computePoints(d);
        html += `
          <div class="list-row">
            <div>${d.date || "-"}<br><span class="muted">${num(d.gas)} GAs</span></div>
            <div>${pts.total.toFixed(1)} pts<br><span class="muted">Bonus: ${pts.bonusTotal.toFixed(1)}</span></div>
            <div>${num(d.ocExisting)} OC ex<br>${num(d.ocNew)} OC new</div>
          </div>
        `;
      });
    container.innerHTML = html;
  }

  // ---------- RENDER: DASHBOARD ----------
  function renderDashboard() {
    const agg = aggregate();
    const kpiContainer = document.getElementById("kpiContainer");
    const pointsBreakdown = document.getElementById("pointsBreakdown");
    const scoreSummary = document.getElementById("scoreSummary");
    const daysInfo = document.getElementById("daysInfo");

    daysInfo.textContent = `${agg.usedDaysCount || 0}/${settings.daysInMonth} days`;

    // KPI table
    let kpiHtml = "";
    KPI_DEFS.forEach(k => {
      let totalVal = 0;
      if (k.key === "homeInternet") totalVal = agg.homeInternet;
      else if (k.key === "points")   totalVal = agg.totalPoints;
      else totalVal = agg[k.key] || 0;

      const target = settings.targets[k.key] || 0;
      const p = kpiProgress(totalVal, target);
      const perc = Math.max(0, p.ratio * 100);
      let pillClass = "pill-mid", pillText = `${perc.toFixed(1)}%`;

      if (!target) {
        pillClass = "pill-mid";
        pillText = "No target";
      } else if (perc >= 110) {
        pillClass = "pill-over";
      } else if (perc >= 100) {
        pillClass = "pill-ok";
      } else if (perc < 80) {
        pillClass = "pill-bad";
      }

      const needed = p.neededPerDay > 0 ? p.neededPerDay.toFixed(2) : "-";

      kpiHtml += `
        <div class="kpi-row">
          <div class="kpi-label">${k.label}</div>
          <div class="kpi-num"><strong>${totalVal}</strong> / ${target || "-"}</div>
          <div>
            <span class="pill ${pillClass}">${pillText}</span>
            <div class="progress"><div class="progress-bar" style="width:${Math.min(perc, 140)}%;"></div></div>
          </div>
          <div class="kpi-num">
            <span class="muted">Need/day</span><br>
            <strong>${needed}</strong>
          </div>
        </div>
      `;
    });
    kpiContainer.innerHTML = kpiHtml;

    // Points breakdown
    let fm=0, corp=0, sim=0, extraAdsl=0, extraMnp=0, extraPrem=0, manual=0;
    days.forEach(d => {
      const p = computePoints(d);
      fm        += p.fmPoints;
      corp      += p.corp;
      sim       += p.sim;
      extraAdsl += p.extraAdsl;
      extraMnp  += p.extraMnp;
      extraPrem += p.extraPremier;
      manual    += p.manual;
    });

    pointsBreakdown.innerHTML = `
      <div class="rule-item">
        <div class="rule-section">Base Points</div>
        <div>${agg.basePoints.toFixed(1)} pts من السيستم مباشرة.</div>
      </div>
      <div class="rule-item">
        <div class="rule-section">FREEmax Buckets</div>
        <div>${fm.toFixed(1)} pts من FREEmax 70/100/150/200/300.</div>
      </div>
      <div class="rule-item">
        <div class="rule-section">Corporate</div>
        <div>${corp.toFixed(1)} pts من New Corporate Accounts.</div>
      </div>
      <div class="rule-item">
        <div class="rule-section">SIM Changes</div>
        <div>${sim.toFixed(1)} pts من تغيير SIM (3G→4G / eSIM).</div>
      </div>
      <div class="rule-item">
        <div class="rule-section">Extra ADSL / MNP / PREMIER</div>
        <div>
          ADSL over target: ${extraAdsl.toFixed(1)} pts<br>
          Extra MNP: ${extraMnp.toFixed(1)} pts<br>
          Extra PREMIER: ${extraPrem.toFixed(1)} pts
        </div>
      </div>
      <div class="rule-item">
        <div class="rule-section">Manual Bonus</div>
        <div>${manual.toFixed(1)} pts (rules not covered).</div>
      </div>
      <div class="rule-item">
        <div class="rule-section">Total</div>
        <div><strong>${agg.totalPoints.toFixed(1)} pts</strong> (Base + All Bonuses).</div>
      </div>
    `;

    // Score & Clawback
    // weighted score
    let totalAgent = 0, totalMgr = 0;
    KPI_DEFS.forEach(k => {
      let totalVal = 0;
      if (k.key === "homeInternet") totalVal = agg.homeInternet;
      else if (k.key === "points") totalVal = agg.totalPoints;
      else totalVal = agg[k.key] || 0;

      const target = settings.targets[k.key] || 0;
      const p = kpiProgress(totalVal, target);
      const ratio = p.ratio || 0;
      totalAgent += ratio * k.wAgent;
      totalMgr   += ratio * k.wMgr;
    });

    // Quality weight (8% للأثنين معًا، تقريبي)
    const qualityWeight = 8;
    const qualityRatio = settings.qualityScore / 100;
    let qualityAgentScore = qualityRatio * qualityWeight;
    let qualityMgrScore   = qualityRatio * qualityWeight;

    // لو NTRA violation: كل Quality يضيع
    if (settings.ntraViolation) {
      qualityAgentScore = 0;
      qualityMgrScore   = 0;
    }

    totalAgent += qualityAgentScore;
    totalMgr   += qualityMgrScore;

    // Clawback
    const postK = KPI_DEFS.find(k => k.key === "postpaid");
    const homeK = KPI_DEFS.find(k => k.key === "homeInternet");

    const postProg = kpiProgress(agg.postpaid, settings.targets.postpaid || 0).ratio;
    const homeProg = kpiProgress(agg.homeInternet, settings.targets.homeInternet || 0).ratio;

    let clawback = 0;
    if (postProg < 1) clawback += 0.05;
    if (homeProg < 1) clawback += 0.05;
    if (settings.qualityScore < 92) clawback += 0.10;

    const finalAgentRaw = totalAgent * (1 - clawback);
    const finalMgrRaw   = totalMgr * (1 - clawback);

    const finalAgent = finalAgentRaw < 80 ? 0 : finalAgentRaw;
    const finalMgr   = finalMgrRaw < 80 ? 0 : finalMgrRaw;

    scoreSummary.innerHTML = `
      <div class="rule-item">
        <div class="rule-section">Weighted Score (before clawback)</div>
        <div>Agent: ${totalAgent.toFixed(2)} – Manager: ${totalMgr.toFixed(2)}</div>
      </div>
      <div class="rule-item">
        <div class="rule-section">Clawback %</div>
        <div>
          Postpaid achieved? ${postProg >= 1 ? "Yes" : "No"}<br>
          Home Internet achieved? ${homeProg >= 1 ? "Yes" : "No"}<br>
          Quality score: ${settings.qualityScore || 0}% (NTRA violation: ${settings.ntraViolation ? "Yes" : "No"})<br>
          <strong>Total clawback: ${(clawback * 100).toFixed(1)}%</strong>
        </div>
      </div>
      <div class="rule-item">
        <div class="rule-section">Final Score (after clawback)</div>
        <div>
          Agent: <strong>${finalAgent.toFixed(2)}</strong> ${finalAgent === 0 ? "(No payment if < 80)" : ""}<br>
          Manager: <strong>${finalMgr.toFixed(2)}</strong> ${finalMgr === 0 ? "(No payment if < 80)" : ""}
        </div>
      </div>
    `;
  }

  // ---------- TABS ----------
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.screen).classList.add("active");
      if (btn.dataset.screen === "screen-dashboard") renderDashboard();
    });
  });

  // ---------- SAVE DAY ----------
  document.getElementById("saveDayBtn").addEventListener("click", () => {
    const entry = {
      date: document.getElementById("date").value,
      gas: document.getElementById("gas").value,
      ocExisting: document.getElementById("ocExisting").value,
      ocNew: document.getElementById("ocNew").value,
      postpaid: document.getElementById("postpaid").value,
      adsl: document.getElementById("adsl").value,
      wireless: document.getElementById("wireless").value,
      devices: document.getElementById("devices").value,
      basePoints: document.getElementById("basePoints").value,
      fm70: document.getElementById("fm70").value,
      fm100: document.getElementById("fm100").value,
      fm150: document.getElementById("fm150").value,
      fm200: document.getElementById("fm200").value,
      fm300: document.getElementById("fm300").value,
      corpNewAcc: document.getElementById("corpNewAcc").value,
      corpNewLines: document.getElementById("corpNewLines").value,
      corpOtherLines: document.getElementById("corpOtherLines").value,
      sim34: document.getElementById("sim34").value,
      simEsim: document.getElementById("simEsim").value,
      extraAdsl: document.getElementById("extraAdsl").value,
      extraMnp: document.getElementById("extraMnp").value,
      extraPremier: document.getElementById("extraPremier").value,
      manualBonus: document.getElementById("manualBonus").value
    };

    // remove existing with same date (overwrite)
    days = days.filter(d => d.date !== entry.date);
    days.push(entry);

    const pts = computePoints(entry);
    alert(`Saved.\nTotal points today: ${pts.total.toFixed(1)} (bonus ${pts.bonusTotal.toFixed(1)})`);

    recalcAndSave();
  });

  // ---------- SAVE SETTINGS ----------
  document.getElementById("saveSettingsBtn").addEventListener("click", () => {
    settings.daysInMonth = num(document.getElementById("daysInMonth").value) || settings.daysInMonth;
    settings.qualityScore = num(document.getElementById("qualityScore").value) || 0;
    settings.ntraViolation = document.getElementById("ntraViolation").checked;

    settings.targets.gas          = num(document.getElementById("tGas").value);
    settings.targets.ocExisting   = num(document.getElementById("tOcExisting").value);
    settings.targets.ocNew        = num(document.getElementById("tOcNew").value);
    settings.targets.points       = num(document.getElementById("tPoints").value);
    settings.targets.postpaid     = num(document.getElementById("tPostpaid").value);
    settings.targets.homeInternet = num(document.getElementById("tHomeInternet").value);
    settings.targets.devices      = num(document.getElementById("tDevices").value);

    recalcAndSave();
    alert("Settings saved.");
  });

  // ---------- RESET ----------
  document.getElementById("resetAllBtn").addEventListener("click", () => {
    if (!confirm("مسح كل أيام الشهر والإعدادات؟")) return;
    days = [];
    localStorage.removeItem("kpi_days");
    renderDays();
    renderDashboard();
  });

  // ---------- INIT FORM WITH SETTINGS ----------
  function loadSettingsToForm() {
    document.getElementById("daysInMonth").value   = settings.daysInMonth;
    document.getElementById("qualityScore").value  = settings.qualityScore;
    document.getElementById("ntraViolation").checked = !!settings.ntraViolation;
    document.getElementById("tGas").value          = settings.targets.gas || "";
    document.getElementById("tOcExisting").value   = settings.targets.ocExisting || "";
    document.getElementById("tOcNew").value        = settings.targets.ocNew || "";
    document.getElementById("tPoints").value       = settings.targets.points || "";
    document.getElementById("tPostpaid").value     = settings.targets.postpaid || "";
    document.getElementById("tHomeInternet").value = settings.targets.homeInternet || "";
    document.getElementById("tDevices").value      = settings.targets.devices || "";
  }

  loadSettingsToForm();
  renderDays();
  renderDashboard();
</script>
</body>
</html>
