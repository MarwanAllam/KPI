<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Retail KPI Pro Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #020617;
      --card-soft: #020817;
      --accent: #f97316;
      --accent-soft: rgba(249,115,22,0.15);
      --green: #22c55e;
      --red: #ef4444;
      --amber: #facc15;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left,#1f2937,#020617 55%);
      color: var(--text);
      padding: 12px;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    header {
      background: linear-gradient(135deg,#ea580c,#f97316,#fb923c);
      padding: 14px 16px;
      border-radius: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      margin-bottom: 14px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    header h1 span {
      font-size: 13px;
      opacity: .85;
      font-weight: 500;
    }
    header .badge {
      background: rgba(15,23,42,0.25);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }
    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px;
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: #fed7aa;
      font-weight: 600;
    }

    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }

    .card {
      background: radial-gradient(circle at top left,#020617,var(--card));
      border-radius: var(--radius);
      padding: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
      margin-bottom: 10px;
    }
    .card h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card h2 small {
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
      gap: 10px;
    }
    label {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    input, select {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 7px 9px;
      font-size: 13px;
      background: rgba(15,23,42,0.9);
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(249,115,22,0.4);
    }

    .btn-row {
      grid-column: 1 / -1;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    .btn-primary {
      background: var(--accent);
      color: #111827;
    }
    .btn-ghost {
      background: rgba(15,23,42,0.7);
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .btn-danger {
      background: rgba(248,113,113,0.1);
      border: 1px solid rgba(248,113,113,0.6);
      color: #fecaca;
    }

    .pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill.ok { background: rgba(34,197,94,0.12); color: #bbf7d0; }
    .pill.warn { background: rgba(250,204,21,0.12); color: #fef9c3; }
    .pill.bad { background: rgba(248,113,113,0.14); color: #fee2e2; }
    .pill.info { background: rgba(148,163,184,0.18); color: #e5e7eb; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    th, td {
      border-bottom: 1px solid rgba(15,23,42,0.9);
      padding: 4px 6px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.75);
    }
    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.95);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap: 8px;
    }
    .kpi-card {
      background: rgba(15,23,42,0.95);
      border-radius: 12px;
      padding: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
    }
    .kpi-title {
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .kpi-main {
      font-size: 16px;
      font-weight: 600;
    }
    .muted {
      color: var(--muted);
      font-size: 11px;
    }
    .status-over   { color: var(--green); }
    .status-ok     { color: #a7f3d0; }
    .status-track  { color: var(--amber); }
    .status-below  { color: var(--red); }

    .two-cols {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 8px;
    }

    .rules-list {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .toast {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.98);
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 12px;
      border: 1px solid var(--accent);
      color: #fed7aa;
      box-shadow: 0 10px 30px rgba(0,0,0,0.7);
      display: none;
      z-index: 100;
    }

    @media (max-width: 640px) {
      header { border-radius: 18px; }
      header h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Retail KPI <span>Pro Dashboard</span></h1>
    <div class="badge">Offline App Â· Local Storage</div>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="daily">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</button>
    <button class="tab-btn" data-tab="dashboard">Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
    <button class="tab-btn" data-tab="settings">Ø§Ù„ØªØ§Ø±Ø¬Øª & Ø§Ù„Ø±ÙˆÙ„Ø²</button>
  </div>

  <!-- DAILY SCREEN -->
  <section id="daily" class="screen active">
    <div class="card">
      <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… <small>Ø§Ø®ØªØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ¹Ø¯Ù‘Ù„ Ø¹Ù„Ù‰ Ø­Ø§Ø¬Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù‚Ø¨Ù„ ÙƒØ¯Ù‡</small></h2>
      <form id="daily-form">
        <label>
          ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
          <input type="date" id="date" required />
        </label>

        <label>
          GAs (Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ·)
          <input type="number" id="gas" min="0" step="1" />
        </label>

        <label>
          Orange Cash - Ù…Ø­Ø§ÙØ¸ Ù‚Ø¯ÙŠÙ…Ø© (Existing)
          <input type="number" id="ocExist" min="0" step="1" />
        </label>

        <label>
          Orange Cash - Ù…Ø­Ø§ÙØ¸ Ø¬Ø¯ÙŠØ¯Ø©
          <input type="number" id="ocNew" min="0" step="1" />
        </label>

        <label>
          Postpaid Lines
          <input type="number" id="postpaid" min="0" step="1" />
        </label>

        <label>
          Home ADSL
          <input type="number" id="adsl" min="0" step="1" />
        </label>

        <label>
          Home Wireless
          <input type="number" id="wireless" min="0" step="1" />
        </label>

        <label>
          Devices
          <input type="number" id="devices" min="0" step="1" />
        </label>

        <label>
          Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù€ Revenue Ø¨Ø§Ù„Ù€ EGP (ÙŠØ­Ø³Ø¨ Points Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ)
          <input type="number" id="revenue" min="0" step="0.01" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ ØªØºÙŠÙŠØ± SIM 3G â†’ 4G
          <input type="number" id="sim3to4" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ ØªØºÙŠÙŠØ± SIM 3G/4G â†’ eSIM
          <input type="number" id="simToEsim" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„Ø² PREMIER + ADSL / Wireless
          <input type="number" id="premierBundles" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Corporate Ø¬Ø¯ÙŠØ¯Ø©
          <input type="number" id="corpAccounts" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Corporate Ø¬Ø¯ÙŠØ¯Ø©
          <input type="number" id="corpNewLines" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ Ø®Ø·ÙˆØ· MNP Ø²ÙŠØ§Ø¯Ø© Ø¨Ø¹Ø¯ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ØªØ§Ø±Ø¬Øª
          <input type="number" id="extraMnp" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ Ø®Ø·ÙˆØ· PREMIER Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„ØªØ§Ø±Ø¬Øª
          <input type="number" id="extraPremier" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ ADSL Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„ØªØ§Ø±Ø¬Øª
          <input type="number" id="extraAdsl" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ MNP ØºÙŠØ± Ù…Ø¤Ù‡Ù„ / ÙˆØ±Ù‚ Ù†Ø§Ù‚Øµ (ÙŠØ®ØµÙ… 1 GA Ù„ÙƒÙ„ ÙˆØ§Ø­Ø¯Ø©)
          <input type="number" id="badMnp" min="0" step="1" />
        </label>

        <label>
          Ø¹Ø¯Ø¯ MNP Ø§ØªØ¹Ù…Ù„ ÙˆÙ…ØªØ´Ø­Ù†Ø´ (Ù…Ø´ Ù‡ÙŠØªØ­Ø³Ø¨ ÙÙŠ GAs)
          <input type="number" id="unrechargedMnp" min="0" step="1" />
        </label>

        <div class="btn-row">
          <button type="submit" class="btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ…</button>
          <button type="button" id="btn-new" class="btn-ghost">ğŸ§¹ ÙÙˆØ±Ù… Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ù† ØºÙŠØ± Ù…Ø³Ø­ Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)</button>
          <button type="button" id="btn-delete-day" class="btn-danger">ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ… Ø¯Ù‡</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>Ø¢Ø®Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© <small>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ÙØªØ­" Ø¹Ù„Ø´Ø§Ù† ØªØ¹Ø¯Ù‘Ù„</small></h2>
      <div style="max-height:260px;overflow:auto;border-radius:12px;border:1px solid var(--border);">
        <table id="days-table">
          <thead>
            <tr>
              <th>ØªØ§Ø±ÙŠØ®</th>
              <th>GAs</th>
              <th>OC Ù‚Ø¯ÙŠÙ…</th>
              <th>OC Ø¬Ø¯ÙŠØ¯</th>
              <th>Postpaid</th>
              <th>ADSL</th>
              <th>Wireless</th>
              <th>Devices</th>
              <th>Points</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- DASHBOARD SCREEN -->
  <section id="dashboard" class="screen">
    <div class="card">
      <h2>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± <small>Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù„ÙŠ Ø­ÙØ¸ØªÙ‡Ø§ + Ø§Ù„ØªØ§Ø±Ø¬Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</small></h2>
      <div class="kpi-grid" id="kpi-cards"></div>
    </div>

    <div class="card">
      <h2>Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù€ KPI Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© <small>Ù…Ø¹ ÙˆØ²Ù† ÙƒÙ„ KPI ÙˆØ§Ù„Ù€ Clawback</small></h2>
      <div class="two-cols">
        <div>
          <p class="muted">Agent Score</p>
          <p id="agent-score-main" class="kpi-main">0</p>
          <p class="muted" id="agent-score-detail"></p>
        </div>
        <div>
          <p class="muted">Store Manager Score</p>
          <p id="manager-score-main" class="kpi-main">0</p>
          <p class="muted" id="manager-score-detail"></p>
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS SCREEN -->
  <section id="settings" class="screen">
    <div class="card">
      <h2>Ø§Ù„ØªØ§Ø±Ø¬Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ <small>Ø§Ù„Ù‚ÙŠÙ… Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ø§Ù„Ø£Ø¨Ù„ÙƒÙŠØ´Ù† Ù‡ÙŠÙ‚Ø§Ø±Ù† Ø¹Ù„ÙŠÙ‡Ø§</small></h2>
      <form id="targets-form">
        <label>ØªØ§Ø±Ø¬Øª GAs (Lines)
          <input type="number" id="t-gas" min="0" />
        </label>
        <label>ØªØ§Ø±Ø¬Øª OC Existing Wallets
          <input type="number" id="t-ocExist" min="0" />
        </label>
        <label>ØªØ§Ø±Ø¬Øª OC New Wallets
          <input type="number" id="t-ocNew" min="0" />
        </label>
        <label>ØªØ§Ø±Ø¬Øª Postpaid Lines
          <input type="number" id="t-postpaid" min="0" />
        </label>
        <label>ØªØ§Ø±Ø¬Øª Home Internet (ADSL + Wireless)
          <input type="number" id="t-home" min="0" />
        </label>
        <label>ØªØ§Ø±Ø¬Øª Devices
          <input type="number" id="t-devices" min="0" />
        </label>
        <label>ØªØ§Ø±Ø¬Øª Points
          <input type="number" id="t-points" min="0" />
        </label>
        <label>ØªØ§Ø±Ø¬Øª OC Existing KPI (%) Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Threshold
          <input type="number" id="t-ocKpi" min="0" max="100" />
        </label>

        <label>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø±
          <input type="number" id="t-days" min="1" max="31" />
        </label>

        <label>Quality Overall Score % (Ù…Ù† Ø§Ù„Ø³ÙŠØ³ØªÙ…)
          <input type="number" id="quality-score" min="0" max="100" />
        </label>

        <label>Ù‡Ù„ Postpaid KPI Ù…ØªØ­Ù‚Ù‚ØŸ
          <select id="postpaid-ok">
            <option value="auto">Ø§Ø­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù†Ø³Ø¨Ø©</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </label>

        <label>Ù‡Ù„ ADSL/Home KPI Ù…ØªØ­Ù‚Ù‚ØŸ
          <select id="adsl-ok">
            <option value="auto">Ø§Ø­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù†Ø³Ø¨Ø©</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </label>

        <div class="btn-row">
          <button type="submit" class="btn-primary">âœ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>Ù‚ÙˆØ§Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ Points <small>ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¯ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ³ØªÙ…</small></h2>
      <form id="rules-form">
        <label>ÙƒÙ„ ÙƒØ§Ù… EGP = 1 Point
          <input type="number" id="r-egpPerPoint" step="0.01" />
        </label>
        <label>Points Ù„ÙƒÙ„ ØªØºÙŠÙŠØ± SIM 3G â†’ 4G
          <input type="number" id="r-sim3to4" step="0.1" />
        </label>
        <label>Points Ù„ÙƒÙ„ ØªØºÙŠÙŠØ± SIM â†’ eSIM
          <input type="number" id="r-simToEsim" step="0.1" />
        </label>
        <label>Points Ù„ÙƒÙ„ Corporate New Account
          <input type="number" id="r-corpAccount" step="0.1" />
        </label>
        <label>Bonus Points Ù„ÙƒÙ„ Ø®Ø· MNP Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ§Ø±Ø¬Øª
          <input type="number" id="r-extraMnp" step="0.1" />
        </label>
        <label>Bonus Points Ù„ÙƒÙ„ Ø®Ø· PREMIER Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„ØªØ§Ø±Ø¬Øª
          <input type="number" id="r-extraPremier" step="0.1" />
        </label>
        <label>Bonus Points Ù„ÙƒÙ„ ADSL Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„ØªØ§Ø±Ø¬Øª
          <input type="number" id="r-extraAdsl" step="0.1" />
        </label>
        <label>Bonus Points Ù„ÙƒÙ„ Bundle PREMIER + ADSL/Wireless
          <input type="number" id="r-premierBundle" step="0.1" />
        </label>

        <div class="btn-row">
          <button type="submit" class="btn-primary">ğŸ’¾ Ø­ÙØ¸ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙˆÙŠÙ†Øª</button>
          <button type="button" id="btn-reset-rules" class="btn-ghost">â†© Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯ÙŠÙÙˆÙ„Øª</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>Ù†Øµ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù€ KPI <small>Reference Ù„Ù„Ø±ÙˆÙ„Ø² Ø§Ù„ÙƒØ§Ù…Ù„Ø©</small></h2>
      <div class="rules-list">
        <table>
          <thead>
          <tr><th>Section</th><th>Detail</th></tr>
          </thead>
          <tbody>
          <tr><td>Cross / Upselling Bonus</td><td>Double points on selling PREMIER with ADSL or Home Wireless as a bundle</td></tr>
          <tr><td>Cross / Upselling Bonus</td><td>Tariff migration upgrades from FREEmax or Prepaid to PREMIER are counted by the difference of tariffs points</td></tr>
          <tr><td>Cross / Upselling Bonus</td><td>Tariff upgrade between PREMIER tariffs is counted by the difference of tariffs points</td></tr>
          <tr><td>Extra Bonus</td><td>FREEmax Revamp: from FREEmax 70 and above, all tariffs get +3 points in calculation</td></tr>
          <tr><td>Extra Bonus</td><td>Double points on each extra ADSL subscription over target</td></tr>
          <tr><td>Extra Bonus</td><td>Extra 10 points on each additional MNP line after achieving the target</td></tr>
          <tr><td>Extra Bonus</td><td>30 points bonus on each extra PREMIER line over achievement</td></tr>
          <tr><td>Extra Bonus</td><td>If all agents achieve 105%+ on Productivity KPI, extra 5% granted to shop manager</td></tr>
          <tr><td>Corporate New Account</td><td>New corporate account achievement = 12 points</td></tr>
          <tr><td>Corporate New Account</td><td>Corporate lines are calculated as GAs</td></tr>
          <tr><td>Corporate New Account</td><td>New lines in new corporate account get double points</td></tr>
          <tr><td>Corporate New Account</td><td>Applies to MNP corporate new accounts</td></tr>
          <tr><td>General Rules</td><td>Postpaid MNP is counted in Postpaid KPI</td></tr>
          <tr><td>General Rules</td><td>10 EGP = 1 point (Premier, FREEmax, Alo, Corp, MNP, ADSL, MI, MBB)</td></tr>
          <tr><td>General Rules</td><td>Change SIM 3G to 4G grants 1.5 points</td></tr>
          <tr><td>General Rules</td><td>Change SIM 3G/4G to eSIM grants 3 points</td></tr>
          <tr><td>General Rules</td><td>Overall KPIs score below 80% = No payment</td></tr>
          <tr><td>General Rules</td><td>ALO not counted in GAs unless charged with 20 EGP</td></tr>
          <tr><td>General Rules</td><td>King tariffs counted in GAs & points only if sold to foreigners with passport in touristic areas</td></tr>
          <tr><td>General Rules</td><td>FREEmax 40 EGP & below not counted in GAs or points</td></tr>
          <tr><td>General Rules</td><td>Unqualified MNP or missing documents: penalty of deducting 1 GA</td></tr>
          <tr><td>General Rules</td><td>MNP not recharged will not be counted in GAs (quantity)</td></tr>
          <tr><td>General Rules</td><td>Postpaid claw back applied after 20% threshold</td></tr>
          <tr><td>General Rules</td><td>ADSL points: full points from Retail activation + 50% from Tele-Sales & Resellers</td></tr>
          <tr><td>General Rules</td><td>MI achievements only counted on MI buckets with new GAs</td></tr>
          <tr><td>General Rules</td><td>Weight of any KPI without target will be added to GAs KPI</td></tr>
          <tr><td>Orange Cash KPI</td><td>Active wallets only (Direct Cash In) are counted</td></tr>
          <tr><td>Orange Cash KPI</td><td>Store Managers accountable for 95% of OC contracts delivery</td></tr>
          <tr><td>Orange Cash KPI</td><td>Extra new wallets counted on existing OC achievements after achieving threshold on OC wallets for existing customers KPI</td></tr>
          <tr><td>Quality KPI</td><td>If NTRA visit violation recorded, all Quality KPI will be lost</td></tr>
          <tr><td>Quality KPI</td><td>If Postpaid KPIs not achieved, 5% claw back on overall final KPI</td></tr>
          <tr><td>Quality KPI</td><td>If ADSL KPIs not achieved, 5% claw back on overall final KPI</td></tr>
          <tr><td>Quality KPI</td><td>Score below 92%: 10% claw back applied in same month from overall SIP score</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script>
  // ===== Storage Keys =====
  const STORAGE_DAYS = "kpi_days_v2";
  const STORAGE_SETTINGS = "kpi_settings_v2";

  // ===== Default Settings =====
  const defaultSettings = {
    targets: {
      gas: 0,
      ocExist: 0,
      ocNew: 0,
      postpaid: 0,
      home: 0,
      devices: 0,
      points: 0,
      ocKpi: 0,
      days: 31
    },
    qualityScore: 100,
    postpaidOkMode: "auto",
    adslOkMode: "auto",
    rules: {
      egpPerPoint: 10,
      sim3to4Points: 1.5,
      simToEsimPoints: 3,
      corpAccountPoints: 12,
      extraMnpPoints: 10,
      extraPremierPoints: 30,
      extraAdslPoints: 0,      // ØªØ­Ø· Ø±Ù‚Ù… Ù„Ùˆ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨ØªØ¯ÙŠ Ø¨ÙˆÙŠÙ†Øª Ø²ÙŠØ§Ø¯Ø© Ù„ÙƒÙ„ ADSL over target
      premierBundlePoints: 0   // ØªØ­Ø· Ø±Ù‚Ù… Ù„Ùˆ ÙÙŠ Bonus Ø«Ø§Ø¨Øª Ù„Ù„Ø¨Ø§Ù†Ø¯Ù„
    }
  };

  // KPI weights (Agent / Manager)
  const KPI_WEIGHTS = {
    gas:     { agent: 40, manager: 30 },
    points:  { agent: 15, manager: 10 },
    product: { agent: 0,  manager: 15 }, // Productivity
    ocExist: { agent: 10, manager: 10 },
    postpaid:{ agent: 10, manager: 10 },
    home:    { agent: 12, manager: 12 },
    devices: { agent: 5,  manager: 5  },
    qualityVisits: { agent: 4, manager: 4 },
    qualityCsat:   { agent: 4, manager: 4 }
  };

  // ===== State =====
  let days = {};
  let settings = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || "null") || structuredClone(defaultSettings);

  function saveSettings() {
    localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
  }

  function loadDays() {
    days = JSON.parse(localStorage.getItem(STORAGE_DAYS) || "{}");
  }
  function saveDays() {
    localStorage.setItem(STORAGE_DAYS, JSON.stringify(days));
  }

  // ===== Helpers =====
  function num(v) {
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  function showToast(msg) {
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.display = "block";
    setTimeout(() => el.style.display = "none", 2500);
  }

  // ===== Tabs =====
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      document.querySelectorAll(".screen").forEach(s => {
        s.classList.toggle("active", s.id === tab);
      });
      if (tab === "dashboard") {
        renderDashboard();
      }
    });
  });

  // ===== Daily Form =====
  const dailyForm = document.getElementById("daily-form");
  const dateInput = document.getElementById("date");

  function clearForm(keepDate = false) {
    const d = dateInput.value;
    dailyForm.reset();
    if (keepDate) dateInput.value = d;
  }

  function loadDayToForm(dateStr) {
    const d = days[dateStr];
    if (!d) {
      clearForm(true);
      return;
    }
    dateInput.value = dateStr;
    document.getElementById("gas").value = d.gas ?? "";
    document.getElementById("ocExist").value = d.ocExist ?? "";
    document.getElementById("ocNew").value = d.ocNew ?? "";
    document.getElementById("postpaid").value = d.postpaid ?? "";
    document.getElementById("adsl").value = d.adsl ?? "";
    document.getElementById("wireless").value = d.wireless ?? "";
    document.getElementById("devices").value = d.devices ?? "";
    document.getElementById("revenue").value = d.revenue ?? "";
    document.getElementById("sim3to4").value = d.sim3to4 ?? "";
    document.getElementById("simToEsim").value = d.simToEsim ?? "";
    document.getElementById("premierBundles").value = d.premierBundles ?? "";
    document.getElementById("corpAccounts").value = d.corpAccounts ?? "";
    document.getElementById("corpNewLines").value = d.corpNewLines ?? "";
    document.getElementById("extraMnp").value = d.extraMnp ?? "";
    document.getElementById("extraPremier").value = d.extraPremier ?? "";
    document.getElementById("extraAdsl").value = d.extraAdsl ?? "";
    document.getElementById("badMnp").value = d.badMnp ?? "";
    document.getElementById("unrechargedMnp").value = d.unrechargedMnp ?? "";
  }

  dateInput.addEventListener("change", () => {
    if (!dateInput.value) return;
    loadDayToForm(dateInput.value);
  });

  function computePointsForDay(d) {
    const r = settings.rules;
    let points = 0;
    // Base revenue
    points += num(d.revenue) / (r.egpPerPoint || 10);
    // SIM changes
    points += num(d.sim3to4) * (r.sim3to4Points || 0);
    points += num(d.simToEsim) * (r.simToEsimPoints || 0);
    // Corporate
    points += num(d.corpAccounts) * (r.corpAccountPoints || 0);
    // Extras & bonuses
    points += num(d.extraMnp) * (r.extraMnpPoints || 0);
    points += num(d.extraPremier) * (r.extraPremierPoints || 0);
    points += num(d.extraAdsl) * (r.extraAdslPoints || 0);
    points += num(d.premierBundles) * (r.premierBundlePoints || 0);
    // Ù…ÙÙŠØ´ Ø¯Ù‚Ø© 100% Ù„ÙƒÙ„ Ø±ÙˆÙ„ Ù„ÙƒÙ† ÙƒØ¯Ù‡ Ù…ØºØ·ÙŠÙ† ÙƒÙ„ Ø§Ù„Ù„ÙŠ Ù„ÙŠÙ‡ ØªØ£Ø«ÙŠØ± Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆÙŠÙ†Øª
    return Math.round(points);
  }

  dailyForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const dateStr = dateInput.value;
    if (!dateStr) {
      showToast("Ø§Ø®ØªØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ÙˆÙ„");
      return;
    }
    const d = {
      gas: num(document.getElementById("gas").value),
      ocExist: num(document.getElementById("ocExist").value),
      ocNew: num(document.getElementById("ocNew").value),
      postpaid: num(document.getElementById("postpaid").value),
      adsl: num(document.getElementById("adsl").value),
      wireless: num(document.getElementById("wireless").value),
      devices: num(document.getElementById("devices").value),
      revenue: num(document.getElementById("revenue").value),
      sim3to4: num(document.getElementById("sim3to4").value),
      simToEsim: num(document.getElementById("simToEsim").value),
      premierBundles: num(document.getElementById("premierBundles").value),
      corpAccounts: num(document.getElementById("corpAccounts").value),
      corpNewLines: num(document.getElementById("corpNewLines").value),
      extraMnp: num(document.getElementById("extraMnp").value),
      extraPremier: num(document.getElementById("extraPremier").value),
      extraAdsl: num(document.getElementById("extraAdsl").value),
      badMnp: num(document.getElementById("badMnp").value),
      unrechargedMnp: num(document.getElementById("unrechargedMnp").value)
    };
    d.points = computePointsForDay(d);

    // GA penalties
    const penaltyGas = d.badMnp;           // deduct 1 GA Ù„ÙƒÙ„ MNP ØºÙŠØ± Ù…Ø¤Ù‡Ù„
    const notCountedGas = d.unrechargedMnp;// Ù…Ø´ Ù‡ÙŠØªØ­Ø³Ø¨ÙˆØ§ ÙÙŠ Ø§Ù„Ù€ quantity
    d.netGas = Math.max(0, d.gas - penaltyGas - notCountedGas);

    days[dateStr] = d;
    saveDays();
    renderDaysTable();
    renderDashboard();
    showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ… âœ…");
    clearForm(false); // Ù†Ù…Ø³Ø­ Ø¹Ù„Ø´Ø§Ù† ØªØ¯Ø®Ù„ Ø¯Ø§ØªØ§ Ø¬Ø¯ÙŠØ¯Ø©
  });

  document.getElementById("btn-new").addEventListener("click", () => {
    clearForm(false);
  });

  document.getElementById("btn-delete-day").addEventListener("click", () => {
    const dateStr = dateInput.value;
    if (!dateStr || !days[dateStr]) {
      showToast("Ù…ÙÙŠØ´ ÙŠÙˆÙ… Ù…Ø­ÙÙˆØ¸ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¯Ù‡");
      return;
    }
    if (!confirm("Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ… Ø¯Ù‡ØŸ")) return;
    delete days[dateStr];
    saveDays();
    renderDaysTable();
    renderDashboard();
    clearForm(false);
    showToast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…");
  });

  function renderDaysTable() {
    const tbody = document.querySelector("#days-table tbody");
    tbody.innerHTML = "";
    const entries = Object.entries(days).sort((a,b) => a[0].localeCompare(b[0]));
    entries.forEach(([dateStr, d]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dateStr}</td>
        <td>${d.netGas ?? d.gas ?? 0}</td>
        <td>${d.ocExist ?? 0}</td>
        <td>${d.ocNew ?? 0}</td>
        <td>${d.postpaid ?? 0}</td>
        <td>${d.adsl ?? 0}</td>
        <td>${d.wireless ?? 0}</td>
        <td>${d.devices ?? 0}</td>
        <td>${d.points ?? 0}</td>
        <td><button class="btn-ghost" data-open="${dateStr}">ÙØªØ­</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("button[data-open]").forEach(btn => {
      btn.addEventListener("click", () => {
        const d = btn.getAttribute("data-open");
        loadDayToForm(d);
        dateInput.value = d;
        document.querySelector('[data-tab="daily"]').click();
      });
    });
  }

  // ===== Settings forms =====
  function fillSettingsForms() {
    const t = settings.targets;
    document.getElementById("t-gas").value = t.gas;
    document.getElementById("t-ocExist").value = t.ocExist;
    document.getElementById("t-ocNew").value = t.ocNew;
    document.getElementById("t-postpaid").value = t.postpaid;
    document.getElementById("t-home").value = t.home;
    document.getElementById("t-devices").value = t.devices;
    document.getElementById("t-points").value = t.points;
    document.getElementById("t-ocKpi").value = t.ocKpi;
    document.getElementById("t-days").value = t.days;
    document.getElementById("quality-score").value = settings.qualityScore;
    document.getElementById("postpaid-ok").value = settings.postpaidOkMode;
    document.getElementById("adsl-ok").value = settings.adslOkMode;

    const r = settings.rules;
    document.getElementById("r-egpPerPoint").value = r.egpPerPoint;
    document.getElementById("r-sim3to4").value = r.sim3to4Points;
    document.getElementById("r-simToEsim").value = r.simToEsimPoints;
    document.getElementById("r-corpAccount").value = r.corpAccountPoints;
    document.getElementById("r-extraMnp").value = r.extraMnpPoints;
    document.getElementById("r-extraPremier").value = r.extraPremierPoints;
    document.getElementById("r-extraAdsl").value = r.extraAdslPoints;
    document.getElementById("r-premierBundle").value = r.premierBundlePoints;
  }

  document.getElementById("targets-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const t = settings.targets;
    t.gas = num(document.getElementById("t-gas").value);
    t.ocExist = num(document.getElementById("t-ocExist").value);
    t.ocNew = num(document.getElementById("t-ocNew").value);
    t.postpaid = num(document.getElementById("t-postpaid").value);
    t.home = num(document.getElementById("t-home").value);
    t.devices = num(document.getElementById("t-devices").value);
    t.points = num(document.getElementById("t-points").value);
    t.ocKpi = num(document.getElementById("t-ocKpi").value);
    t.days = num(document.getElementById("t-days").value) || 31;
    settings.qualityScore = num(document.getElementById("quality-score").value) || 0;
    settings.postpaidOkMode = document.getElementById("postpaid-ok").value;
    settings.adslOkMode = document.getElementById("adsl-ok").value;
    saveSettings();
    renderDashboard();
    showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±Ø¬Øª âœ…");
  });

  document.getElementById("rules-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const r = settings.rules;
    r.egpPerPoint = num(document.getElementById("r-egpPerPoint").value) || 10;
    r.sim3to4Points = num(document.getElementById("r-sim3to4").value);
    r.simToEsimPoints = num(document.getElementById("r-simToEsim").value);
    r.corpAccountPoints = num(document.getElementById("r-corpAccount").value);
    r.extraMnpPoints = num(document.getElementById("r-extraMnp").value);
    r.extraPremierPoints = num(document.getElementById("r-extraPremier").value);
    r.extraAdslPoints = num(document.getElementById("r-extraAdsl").value);
    r.premierBundlePoints = num(document.getElementById("r-premierBundle").value);
    saveSettings();
    renderDashboard();
    showToast("ØªÙ… Ø­ÙØ¸ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙˆÙŠÙ†Øª âœ…");
  });

  document.getElementById("btn-reset-rules").addEventListener("click", () => {
    settings.rules = structuredClone(defaultSettings.rules);
    fillSettingsForms();
    saveSettings();
    showToast("Ø±Ø¬Ù‘Ø¹Ù†Ø§ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙˆÙŠÙ†Øª Ù„Ù„Ø¯ÙŠÙÙˆÙ„Øª");
  });

  // ===== Dashboard =====
  function aggregateDays() {
    const totals = {
      gas: 0, ocExist: 0, ocNew: 0, postpaid: 0,
      adsl: 0, wireless: 0, devices: 0, points: 0
    };
    Object.values(days).forEach(d => {
      totals.gas      += num(d.netGas ?? d.gas);
      totals.ocExist  += num(d.ocExist);
      totals.ocNew    += num(d.ocNew);
      totals.postpaid += num(d.postpaid);
      totals.adsl     += num(d.adsl);
      totals.wireless += num(d.wireless);
      totals.devices  += num(d.devices);
      totals.points   += num(d.points);
    });
    totals.home = totals.adsl + totals.wireless;
    totals.usedDays = Object.keys(days).length;
    return totals;
  }

  function statusClass(pct) {
    if (pct >= 1.1) return "status-over";
    if (pct >= 1.0) return "status-ok";
    if (pct >= 0.8) return "status-track";
    return "status-below";
  }
  function statusLabel(pct) {
    if (pct >= 1.1) return "Over Target";
    if (pct >= 1.0) return "Achieved";
    if (pct >= 0.8) return "On Track";
    return "Below Target";
  }

  function renderDashboard() {
    const totals = aggregateDays();
    const t = settings.targets;
    const daysLeft = Math.max((t.days || 31) - totals.usedDays, 0);

    const kpis = [
      { key: "gas", label: "GAs (Lines)", total: totals.gas, target: t.gas },
      { key: "ocExist", label: "OC Existing Wallets", total: totals.ocExist, target: t.ocExist },
      { key: "ocNew", label: "OC New Wallets", total: totals.ocNew, target: t.ocNew },
      { key: "postpaid", label: "Postpaid Lines", total: totals.postpaid, target: t.postpaid },
      { key: "home", label: "Home Internet (ADSL + Wireless)", total: totals.home, target: t.home },
      { key: "devices", label: "Devices", total: totals.devices, target: t.devices },
      { key: "points", label: "Points", total: totals.points, target: t.points }
    ];

    const container = document.getElementById("kpi-cards");
    container.innerHTML = "";
    kpis.forEach(k => {
      const pct = k.target > 0 ? k.total / k.target : 0;
      const remaining = k.target - k.total;
      const perDay = (daysLeft > 0 && remaining > 0) ? remaining / daysLeft : 0;
      const card = document.createElement("div");
      card.className = "kpi-card";
      card.innerHTML = `
        <div class="kpi-title">
          <span>${k.label}</span>
          <span class="pill info">${k.total.toFixed(0)} / ${k.target.toFixed(0)}</span>
        </div>
        <div class="kpi-main ${statusClass(pct)}">
          ${(pct*100 || 0).toFixed(1)}%
        </div>
        <div class="muted">
          Ø§Ù„Ø­Ø§Ù„Ø©: <span class="${statusClass(pct)}">${statusLabel(pct)}</span><br>
          ${remaining > 0 ? `Ù†Ø§Ù‚Øµ: ${remaining.toFixed(0)} Â· Ù…Ø­ØªØ§Ø¬ ØªØ¹Ù…Ù„ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ${perDay.toFixed(1)} ÙÙŠ Ø§Ù„ÙŠÙˆÙ… (Ø£ÙŠØ§Ù… Ø¨Ø§Ù‚ÙŠØ©: ${daysLeft})` : "Ø§Ù„ØªØ§Ø±Ø¬Øª Ù…ØªØ­Ù‚Ù‚ Ø£Ùˆ Over"}
        </div>
      `;
      container.appendChild(card);
    });

    // ---- KPI Scores & Clawback ----
    const pctGas      = t.gas      ? totals.gas      / t.gas      : 0;
    const pctPoints   = t.points   ? totals.points   / t.points   : 0;
    const pctOcExist  = t.ocExist  ? totals.ocExist  / t.ocExist  : 0;
    const pctPostpaid = t.postpaid ? totals.postpaid / t.postpaid : 0;
    const pctHome     = t.home     ? totals.home     / t.home     : 0;
    const pctDevices  = t.devices  ? totals.devices  / t.devices  : 0;

    // Ù‡Ù†Ø§ Ø§Ø¹ØªØ¨Ø±Ù†Ø§ Quality KPIs ØªØ¯ÙŠÙƒ Ù†Ø³Ø¨Ø© Ù…Ù† 0 Ù„Ù€ 1 Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù€ Quality Score
    const qualityScore = settings.qualityScore || 0;
    const pctQuality = qualityScore / 100;

    function weighted(pct, key, role) {
      return pct * (KPI_WEIGHTS[key][role] || 0);
    }

    const agentTotal =
      weighted(pctGas,"gas","agent") +
      weighted(pctPoints,"points","agent") +
      weighted(pctOcExist,"ocExist","agent") +
      weighted(pctPostpaid,"postpaid","agent") +
      weighted(pctHome,"home","agent") +
      weighted(pctDevices,"devices","agent") +
      weighted(pctQuality,"qualityVisits","agent") +
      weighted(pctQuality,"qualityCsat","agent");

    const managerTotal =
      weighted(pctGas,"gas","manager") +
      weighted(pctPoints,"points","manager") +
      weighted(1,"product","manager") + // Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© ØºØ§Ù„Ø¨Ù‹Ø§ 100% Ù‡Ù†Ø§Ø› ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ù„Ùˆ Ø¹Ø§ÙŠØ²
      weighted(pctOcExist,"ocExist","manager") +
      weighted(pctPostpaid,"postpaid","manager") +
      weighted(pctHome,"home","manager") +
      weighted(pctDevices,"devices","manager") +
      weighted(pctQuality,"qualityVisits","manager") +
      weighted(pctQuality,"qualityCsat","manager");

    // Postpaid & ADSL KPI achieved?
    let postpaidOk;
    if (settings.postpaidOkMode === "yes") postpaidOk = true;
    else if (settings.postpaidOkMode === "no") postpaidOk = false;
    else postpaidOk = pctPostpaid >= 1.0;

    let adslOk;
    if (settings.adslOkMode === "yes") adslOk = true;
    else if (settings.adslOkMode === "no") adslOk = false;
    else adslOk = pctHome >= 1.0;

    let clawback = 0;
    if (!postpaidOk) clawback += 0.05;
    if (!adslOk) clawback += 0.05;
    if (qualityScore < 92) clawback += 0.10;

    const agentFinal   = agentTotal   < 80 ? 0 : agentTotal   * (1 - clawback);
    const managerFinal = managerTotal < 80 ? 0 : managerTotal * (1 - clawback);

    document.getElementById("agent-score-main").textContent   = agentFinal.toFixed(2);
    document.getElementById("manager-score-main").textContent = managerFinal.toFixed(2);
    document.getElementById("agent-score-detail").textContent =
      `Ù‚Ø¨Ù„ Ø§Ù„Ù€ Clawback: ${agentTotal.toFixed(2)} Â· Clawback = ${(clawback*100).toFixed(1)}%`;
    document.getElementById("manager-score-detail").textContent =
      `Ù‚Ø¨Ù„ Ø§Ù„Ù€ Clawback: ${managerTotal.toFixed(2)} Â· Clawback = ${(clawback*100).toFixed(1)}%`;
  }

  // ===== Init =====
  loadDays();
  renderDaysTable();
  fillSettingsForms();
  renderDashboard();
</script>
</body>
</html>
