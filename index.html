<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Retail KPI Pro Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0f172a;color:#e5e7eb}
    .app-header{padding:16px 16px 8px;background:#020617;border-bottom:1px solid #1f2937;text-align:center;position:sticky;top:0;z-index:10}
    .app-header h1{margin:0;font-size:20px;color:#f97316;font-weight:700}
    .subtitle{margin:4px 0 0;font-size:12px;color:#9ca3af}
    .tabs{display:flex;background:#020617;border-bottom:1px solid #1f2937}
    .tab-btn{flex:1;padding:10px 4px;background:transparent;border:0;border-bottom:2px solid transparent;color:#9ca3af;font-size:13px;font-weight:500;cursor:pointer}
    .tab-btn.active{color:#f97316;border-color:#f97316;background:#111827}
    .view{display:none;padding:12px 12px 70px}
    .view.active{display:block}
    .card{background:#020617;border-radius:14px;padding:12px 12px 14px;margin:8px 0;border:1px solid #1f2937;box-shadow:0 12px 30px rgba(15,23,42,0.7)}
    .card h2{margin:0 0 8px;font-size:15px;color:#e5e7eb}
    .card h3{margin:10px 0 4px;font-size:13px;color:#f97316}
    .card-header-row{display:flex;justify-content:space-between;align-items:center}
    .two-col,.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media (max-width:640px){
      .two-col,.grid-2{grid-template-columns:1fr}
    }
    label{font-size:12px;color:#9ca3af;display:flex;flex-direction:column;gap:4px}
    input,select{padding:8px 9px;border-radius:10px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:13px}
    input:focus,select:focus{outline:none;border-color:#f97316;box-shadow:0 0 0 1px rgba(249,115,22,0.4)}
    .primary-btn,.ghost-btn{border-radius:999px;border:0;padding:9px 16px;font-size:13px;font-weight:600;cursor:pointer}
    .primary-btn{background:linear-gradient(135deg,#fb923c,#f97316);color:#111827;box-shadow:0 4px 14px rgba(249,115,22,0.4)}
    .primary-btn.small{padding:6px 12px;font-size:12px}
    .primary-btn:active{transform:translateY(1px);box-shadow:0 2px 8px rgba(249,115,22,0.35)}
    .ghost-btn{background:transparent;border:1px solid #374151;color:#9ca3af}
    .btn-row{display:flex;gap:8px;justify-content:space-between}
    .btn-row button{flex:1}
    .hint{margin-top:6px;font-size:11px;color:#6b7280}
    .app-footer{position:fixed;bottom:0;left:0;right:0;background:#020617;border-top:1px solid #1f2937;padding:8px 12px;font-size:11px;color:#6b7280;text-align:center}
    .info-row{margin-top:10px;padding:8px;border-radius:10px;background:rgba(15,23,42,0.9);display:flex;flex-direction:column;gap:4px;font-size:12px}
    .info-row .label{color:#9ca3af}
    .strong{font-weight:700}
    .accent{color:#facc15}
    .saved-list{display:flex;flex-direction:column;gap:8px;font-size:12px}
    .saved-item{padding:8px;border-radius:10px;border:1px solid #1f2937;background:#020617;display:flex;justify-content:space-between;align-items:flex-start;cursor:pointer}
    .saved-main{font-weight:600;color:#e5e7eb}
    .saved-meta{font-size:11px;color:#9ca3af;margin-top:4px}
    .tag{display:inline-block;padding:2px 6px;border-radius:999px;font-size:10px;margin-right:4px}
    .tag-ok{background:rgba(22,163,74,0.15);color:#4ade80}
    .tag-warn{background:rgba(234,179,8,0.15);color:#fde68a}
    .tag-bad{background:rgba(220,38,38,0.2);color:#fecaca}
    .empty-state{color:#6b7280;text-align:center;padding:12px;border:1px dashed #374151;border-radius:10px}
    .add-user-row{display:flex;gap:8px;margin-top:8px}
    .add-user-row input{flex:1}
    .user-row{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:10px;border:1px solid #1f2937;margin-bottom:6px;font-size:12px}
    .user-row span{display:block}
    .user-row button{border-radius:999px;border:0;background:#b91c1c;color:#fee2e2;font-size:11px;padding:4px 8px;cursor:pointer}
    .table{width:100%;border-collapse:collapse;font-size:12px;margin-top:6px}
    .table th,.table td{border-bottom:1px solid #1f2937;padding:6px 4px;text-align:right}
    .table th:first-child,.table td:first-child{text-align:left}
    .badge{padding:2px 6px;border-radius:999px;font-size:10px}
    .badge-good{background:rgba(22,163,74,0.15);color:#4ade80}
    .badge-mid{background:rgba(234,179,8,0.15);color:#fde68a}
    .badge-bad{background:rgba(220,38,38,0.2);color:#fecaca}
    .user-card{margin-top:10px;padding:10px;border-radius:12px;border:1px solid #1f2937;background:#020617;box-shadow:0 8px 20px rgba(15,23,42,0.6)}
    .user-card h3{margin:0 0 4px;font-size:13px;color:#f97316}
    .user-card .sub{font-size:11px;color:#9ca3af;margin-bottom:4px}
    .saved-actions{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .delete-btn{border-radius:999px;border:0;background:#7f1d1d;color:#fee2e2;font-size:10px;padding:3px 7px;cursor:pointer}
  </style>
</head>
<body>
  <header class="app-header">
    <h1>Retail KPI Pro</h1>
    <p class="subtitle">Daily tracker • rules engine • dashboard</p>
  </header>

  <nav class="tabs">
    <button class="tab-btn active" data-view="entryView">Daily Entry</button>
    <button class="tab-btn" data-view="dashboardView">Dashboard</button>
    <button class="tab-btn" data-view="settingsView">Settings</button>
  </nav>

  <!-- ===== DAILY ENTRY ===== -->
  <main class="view active" id="entryView">
    <section class="card">
      <h2>Day &amp; User</h2>
      <div class="two-col">
        <label>
          Date
          <input type="date" id="entryDate" />
        </label>
        <label>
          User
          <select id="entryUser"></select>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>KPIs (raw numbers)</h2>
      <div class="grid-2">
        <label>GAs (Lines)<input type="number" id="gas" min="0" /></label>
        <label>OC Existing Wallets<input type="number" id="ocExisting" min="0" /></label>
        <label>OC New Wallets<input type="number" id="ocNew" min="0" /></label>
        <label>Postpaid Lines<input type="number" id="postpaid" min="0" /></label>
        <label>Home ADSL Subs<input type="number" id="adsl" min="0" /></label>
        <label>Home Wireless Subs<input type="number" id="wireless" min="0" /></label>
        <label>Devices<input type="number" id="devices" min="0" /></label>
        <label>Manual base points<br/><small>(from billing etc.)</small>
          <input type="number" id="manualPoints" step="0.1" />
        </label>
      </div>
    </section>

    <section class="card">
      <div class="card-header-row">
        <h2>Rules &amp; Bonuses</h2>
        <button type="button" id="toggleRules" class="ghost-btn">Hide / Show</button>
      </div>
      <div id="rulesBlock">
        <h3>Cross / Upselling & Extra Bonus</h3>
        <div class="grid-2">
          <label># PREMIER + ADSL / HW bundles
            <input type="number" id="r_bundlePremierAdsl" min="0" />
          </label>
          <label># Extra ADSL subs over target
            <input type="number" id="r_extraAdsl" min="0" />
          </label>
          <label># Extra MNP lines over target
            <input type="number" id="r_extraMnp" min="0" />
          </label>
          <label># Extra PREMIER lines over achievement
            <input type="number" id="r_extraPremier" min="0" />
          </label>
        </div>

        <h3>Corporate Accounts</h3>
        <div class="grid-2">
          <label># New corporate accounts
            <input type="number" id="r_newCorpAcc" min="0" />
          </label>
          <label># Corporate lines in new accounts
            <input type="number" id="r_newCorpLines" min="0" />
          </label>
        </div>

        <h3>SIM Changes</h3>
        <div class="grid-2">
          <label># SIM 3G → 4G
            <input type="number" id="r_sim3to4" min="0" />
          </label>
          <label># SIM 3G/4G → eSIM
            <input type="number" id="r_simToEsim" min="0" />
          </label>
        </div>
      </div>

      <div class="info-row">
        <div>
          <span class="label">Auto bonus points today:</span>
          <span id="bonusPointsToday" class="strong">0</span>
        </div>
        <div>
          <span class="label">Total points (manual + bonus):</span>
          <span id="totalPointsToday" class="strong accent">0</span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="btn-row">
        <button id="saveDayBtn" class="primary-btn">Save day</button>
        <button id="clearFormBtn" class="ghost-btn">Clear form</button>
      </div>
      <p class="hint">
        Saving will store the day for the selected user. You can tap any saved day below
        to reload and edit it. You can also delete a record.
      </p>
    </section>

    <section class="card">
      <h2>Last saved days</h2>
      <div id="savedDaysList" class="saved-list empty-state">
        No days yet. Save your first day to see it here.
      </div>
    </section>
  </main>

  <!-- ===== DASHBOARD ===== -->
  <main class="view" id="dashboardView">
    <section class="card">
      <h2>Branch overview</h2>
      <div id="branchOverview"></div>
    </section>

    <section class="card">
      <h2>Per-user progress</h2>
      <div id="userCardsWrapper"></div>
    </section>
  </main>

  <!-- ===== SETTINGS ===== -->
  <main class="view" id="settingsView">
    <section class="card">
      <h2>Branch targets</h2>
      <p class="hint">Set monthly targets for the whole branch. They will be split by user share.</p>
      <div class="grid-2">
        <label>Target GAs<input type="number" id="t_gas" /></label>
        <label>Target OC Existing<input type="number" id="t_ocExisting" /></label>
        <label>Target OC New<input type="number" id="t_ocNew" /></label>
        <label>Target Postpaid<input type="number" id="t_postpaid" /></label>
        <label>Target Home ADSL<input type="number" id="t_adsl" /></label>
        <label>Target Home Wireless<input type="number" id="t_wireless" /></label>
        <label>Target Devices<input type="number" id="t_devices" /></label>
        <label>Target Points<input type="number" id="t_points" /></label>
      </div>
    </section>

    <section class="card">
      <h2>Users &amp; target share</h2>
      <p class="hint">
        Add agents / store managers and the % of branch target assigned to each one.
      </p>
      <div id="usersList"></div>
      <div class="add-user-row">
        <input type="text" id="newUserName" placeholder="New user name" />
        <input type="number" id="newUserShare" placeholder="% share" />
        <button id="addUserBtn" class="primary-btn small">Add</button>
      </div>
    </section>

    <section class="card">
      <h2>Rules engine settings</h2>
      <p class="hint">Tune how many extra points you get for each rule.</p>
      <div class="grid-2">
        <label>Points per new corporate account
          <input type="number" id="s_ptsCorpAcc" step="0.1" />
        </label>
        <label>Points per SIM 3G → 4G
          <input type="number" id="s_ptsSim3to4" step="0.1" />
        </label>
        <label>Points per SIM → eSIM
          <input type="number" id="s_ptsSimToEsim" step="0.1" />
        </label>
        <label>Extra points per extra MNP line
          <input type="number" id="s_ptsExtraMnp" step="0.1" />
        </label>
        <label>Extra points per extra PREMIER line
          <input type="number" id="s_ptsExtraPremier" step="0.1" />
        </label>
        <label>Base ADSL points per sub
          <input type="number" id="s_ptsAdslBase" step="0.1" />
        </label>
        <label>Extra factor on extra ADSL (e.g. 2 for double)
          <input type="number" id="s_factorExtraAdsl" step="0.1" />
        </label>
        <label>Bonus per PREMIER + ADSL bundle
          <input type="number" id="s_ptsBundlePremierAdsl" step="0.1" />
        </label>
      </div>
      <button id="saveSettingsBtn" class="primary-btn">Save settings</button>
    </section>
  </main>

  <footer class="app-footer">
    <span>Retail KPI Pro • local only (saved on your phone)</span>
  </footer>

  <script>
    // ===== STATE MANAGEMENT =====
    const defaultState = {
      users: [
        { id: 'u1', name: 'Branch', share: 100 }
      ],
      targets: {
        gas: 0,
        ocExisting: 0,
        ocNew: 0,
        postpaid: 0,
        adsl: 0,
        wireless: 0,
        devices: 0,
        points: 0
      },
      rules: {
        ptsCorpAcc: 12,
        ptsSim3to4: 1.5,
        ptsSimToEsim: 3,
        ptsExtraMnp: 10,
        ptsExtraPremier: 30,
        ptsAdslBase: 10,
        factorExtraAdsl: 2,
        ptsBundlePremierAdsl: 5
      },
      entries: [] // {id,date,userId,...}
    };

    function cloneDefault() {
      return JSON.parse(JSON.stringify(defaultState));
    }

    function loadState() {
      try {
        const raw = localStorage.getItem('retail_kpi_state_v2');
        if (!raw) return cloneDefault();
        const parsed = JSON.parse(raw);
        return Object.assign(cloneDefault(), parsed);
      } catch (e) {
        console.error('loadState error', e);
        return cloneDefault();
      }
    }

    function saveState() {
      localStorage.setItem('retail_kpi_state_v2', JSON.stringify(state));
    }

    let state = loadState();

    const $ = (id) => document.getElementById(id);

    // ===== TABS =====
    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach((b) =>
          b.classList.toggle('active', b === btn)
        );
        const view = btn.dataset.view;
        document.querySelectorAll('.view').forEach((v) =>
          v.classList.toggle('active', v.id === view)
        );
        if (view === 'dashboardView') renderDashboard();
        if (view === 'settingsView') renderSettings();
      });
    });

    // ===== INIT SELECT & DATE =====
    function populateUserSelect() {
      const sel = $('entryUser');
      const current = sel.value;
      sel.innerHTML = '';
      state.users.forEach((u) => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.name + ' (' + (u.share || 0) + '%)';
        sel.appendChild(opt);
      });
      if (state.users.length && !current) sel.value = state.users[0].id;
      if (current) sel.value = current;
    }

    function setToday() {
      const today = new Date().toISOString().slice(0, 10);
      $('entryDate').value = today;
    }

    // ===== RULES POINTS =====
    function calcBonusPoints(entry) {
      const R = state.rules;
      let pts = 0;
      pts += (entry.r_newCorpAcc || 0) * (R.ptsCorpAcc || 0);
      pts += (entry.r_sim3to4 || 0) * (R.ptsSim3to4 || 0);
      pts += (entry.r_simToEsim || 0) * (R.ptsSimToEsim || 0);
      pts += (entry.r_extraMnp || 0) * (R.ptsExtraMnp || 0);
      pts += (entry.r_extraPremier || 0) * (R.ptsExtraPremier || 0);
      pts += (entry.r_bundlePremierAdsl || 0) * (R.ptsBundlePremierAdsl || 0);
      pts += (entry.r_extraAdsl || 0) * (R.ptsAdslBase || 0) * (R.factorExtraAdsl || 0);
      pts += (entry.r_newCorpLines || 0) * 1; // simple 1pt/line
      return pts;
    }

    // ===== FORM READ / FILL =====
    function readEntryFromForm() {
      const userId = $('entryUser').value;
      const date = $('entryDate').value;
      if (!date || !userId) return null;
      const getNum = (id) => Number($(id).value || 0);

      const e = {
        id: date + '_' + userId,
        date,
        userId,
        gas: getNum('gas'),
        ocExisting: getNum('ocExisting'),
        ocNew: getNum('ocNew'),
        postpaid: getNum('postpaid'),
        adsl: getNum('adsl'),
        wireless: getNum('wireless'),
        devices: getNum('devices'),
        manualPoints: getNum('manualPoints'),
        r_bundlePremierAdsl: getNum('r_bundlePremierAdsl'),
        r_extraAdsl: getNum('r_extraAdsl'),
        r_extraMnp: getNum('r_extraMnp'),
        r_extraPremier: getNum('r_extraPremier'),
        r_newCorpAcc: getNum('r_newCorpAcc'),
        r_newCorpLines: getNum('r_newCorpLines'),
        r_sim3to4: getNum('r_sim3to4'),
        r_simToEsim: getNum('r_simToEsim')
      };
      e.bonusPoints = calcBonusPoints(e);
      e.totalPoints = e.manualPoints + e.bonusPoints;
      return e;
    }

    function fillFormFromEntry(e) {
      $('entryDate').value = e.date;
      $('entryUser').value = e.userId;
      $('gas').value = e.gas || '';
      $('ocExisting').value = e.ocExisting || '';
      $('ocNew').value = e.ocNew || '';
      $('postpaid').value = e.postpaid || '';
      $('adsl').value = e.adsl || '';
      $('wireless').value = e.wireless || '';
      $('devices').value = e.devices || '';
      $('manualPoints').value = e.manualPoints || '';

      $('r_bundlePremierAdsl').value = e.r_bundlePremierAdsl || '';
      $('r_extraAdsl').value = e.r_extraAdsl || '';
      $('r_extraMnp').value = e.r_extraMnp || '';
      $('r_extraPremier').value = e.r_extraPremier || '';
      $('r_newCorpAcc').value = e.r_newCorpAcc || '';
      $('r_newCorpLines').value = e.r_newCorpLines || '';
      $('r_sim3to4').value = e.r_sim3to4 || '';
      $('r_simToEsim').value = e.r_simToEsim || '';

      $('bonusPointsToday').textContent = (e.bonusPoints || 0).toFixed(1);
      $('totalPointsToday').textContent = (e.totalPoints || 0).toFixed(1);
    }

    function clearForm() {
      document.querySelectorAll('#entryView input[type=number]').forEach(inp => inp.value = '');
      $('bonusPointsToday').textContent = '0';
      $('totalPointsToday').textContent = '0';
    }

    // live preview
    document.querySelectorAll('#entryView input').forEach(inp => {
      inp.addEventListener('input', () => {
        const e = readEntryFromForm();
        if (!e) return;
        $('bonusPointsToday').textContent = e.bonusPoints.toFixed(1);
        $('totalPointsToday').textContent = e.totalPoints.toFixed(1);
      });
    });

    $('clearFormBtn').addEventListener('click', clearForm);

    $('toggleRules').addEventListener('click', () => {
      const block = $('rulesBlock');
      block.style.display = block.style.display === 'none' ? 'block' : 'none';
    });

    // ===== SAVE DAY & DELETE DAY =====
    $('saveDayBtn').addEventListener('click', () => {
      const e = readEntryFromForm();
      if (!e) {
        alert('Please select date and user.');
        return;
      }
      const idx = state.entries.findIndex(x => x.id === e.id);
      if (idx >= 0) state.entries[idx] = e;
      else state.entries.push(e);
      saveState();
      renderSavedDays();
      renderDashboard();
      clearForm();
      alert('Day saved. Tap it from the list to edit, or delete it.');
    });

    function renderSavedDays() {
      const container = $('savedDaysList');
      if (!state.entries.length) {
        container.className = 'saved-list empty-state';
        container.textContent = 'No days yet. Save your first day to see it here.';
        return;
      }
      container.className = 'saved-list';
      container.innerHTML = '';

      const sorted = [...state.entries].sort((a,b) =>
        a.date === b.date ? a.userId.localeCompare(b.userId) : a.date.localeCompare(b.date)
      );

      sorted.forEach(e => {
        const user = state.users.find(u => u.id === e.userId);
        const div = document.createElement('div');
        div.className = 'saved-item';

        const info = document.createElement('div');
        info.innerHTML = `
          <div class="saved-main">${e.date} • ${user ? user.name : e.userId}</div>
          <div class="saved-meta">
            GAs: ${e.gas || 0} • OC Ex: ${e.ocExisting || 0} • Postpaid: ${e.postpaid || 0}<br/>
            ADSL: ${e.adsl || 0} • Wireless: ${e.wireless || 0} • Devices: ${e.devices || 0}<br/>
            Points: ${(e.totalPoints || 0).toFixed(1)}
          </div>
        `;
        info.addEventListener('click', () => fillFormFromEntry(e));

        const actions = document.createElement('div');
        actions.className = 'saved-actions';
        const tag = document.createElement('span');
        tag.className = 'tag tag-ok';
        tag.textContent = 'tap to edit';
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (!confirm('Delete this day?')) return;
          state.entries = state.entries.filter(x => x.id !== e.id);
          saveState();
          renderSavedDays();
          renderDashboard();
        });
        actions.appendChild(tag);
        actions.appendChild(delBtn);

        div.appendChild(info);
        div.appendChild(actions);
        container.appendChild(div);
      });
    }

    // ===== SETTINGS =====
    function renderSettings() {
      // targets
      $('t_gas').value = state.targets.gas || '';
      $('t_ocExisting').value = state.targets.ocExisting || '';
      $('t_ocNew').value = state.targets.ocNew || '';
      $('t_postpaid').value = state.targets.postpaid || '';
      $('t_adsl').value = state.targets.adsl || '';
      $('t_wireless').value = state.targets.wireless || '';
      $('t_devices').value = state.targets.devices || '';
      $('t_points').value = state.targets.points || '';

      // users
      const list = $('usersList');
      list.innerHTML = '';
      state.users.forEach(u => {
        const row = document.createElement('div');
        row.className = 'user-row';
        row.innerHTML = `
          <div>
            <span>${u.name}</span>
            <span style="color:#9ca3af;font-size:11px">${u.share || 0}% of branch target</span>
          </div>
          <button data-id="${u.id}">Delete</button>
        `;
        row.querySelector('button').addEventListener('click', () => {
          if (!confirm('Delete this user?')) return;
          state.users = state.users.filter(x => x.id !== u.id);
          saveState();
          renderSettings();
          populateUserSelect();
          renderDashboard();
        });
        list.appendChild(row);
      });

      // rules
      $('s_ptsCorpAcc').value = state.rules.ptsCorpAcc;
      $('s_ptsSim3to4').value = state.rules.ptsSim3to4;
      $('s_ptsSimToEsim').value = state.rules.ptsSimToEsim;
      $('s_ptsExtraMnp').value = state.rules.ptsExtraMnp;
      $('s_ptsExtraPremier').value = state.rules.ptsExtraPremier;
      $('s_ptsAdslBase').value = state.rules.ptsAdslBase;
      $('s_factorExtraAdsl').value = state.rules.factorExtraAdsl;
      $('s_ptsBundlePremierAdsl').value = state.rules.ptsBundlePremierAdsl;
    }

    $('addUserBtn').addEventListener('click', () => {
      const name = $('newUserName').value.trim();
      const share = Number($('newUserShare').value || 0);
      if (!name) {
        alert('Please enter user name');
        return;
      }
      const id = 'u' + Math.random().toString(36).slice(2,8);
      state.users.push({ id, name, share });
      $('newUserName').value = '';
      $('newUserShare').value = '';
      saveState();
      renderSettings();
      populateUserSelect();
      renderDashboard();
    });

    $('saveSettingsBtn').addEventListener('click', () => {
      state.targets = {
        gas: Number($('t_gas').value || 0),
        ocExisting: Number($('t_ocExisting').value || 0),
        ocNew: Number($('t_ocNew').value || 0),
        postpaid: Number($('t_postpaid').value || 0),
        adsl: Number($('t_adsl').value || 0),
        wireless: Number($('t_wireless').value || 0),
        devices: Number($('t_devices').value || 0),
        points: Number($('t_points').value || 0)
      };
      state.rules = {
        ptsCorpAcc: Number($('s_ptsCorpAcc').value || 0),
        ptsSim3to4: Number($('s_ptsSim3to4').value || 0),
        ptsSimToEsim: Number($('s_ptsSimToEsim').value || 0),
        ptsExtraMnp: Number($('s_ptsExtraMnp').value || 0),
        ptsExtraPremier: Number($('s_ptsExtraPremier').value || 0),
        ptsAdslBase: Number($('s_ptsAdslBase').value || 0),
        factorExtraAdsl: Number($('s_factorExtraAdsl').value || 0),
        ptsBundlePremierAdsl: Number($('s_ptsBundlePremierAdsl').value || 0)
      };
      saveState();
      alert('Settings saved');
      renderDashboard();
    });

    // ===== DASHBOARD =====
    function sumEntries(filterFn) {
      const res = {
        gas: 0, ocExisting: 0, ocNew: 0, postpaid: 0,
        adsl: 0, wireless: 0, devices: 0, points: 0
      };
      state.entries.filter(filterFn).forEach(e => {
        res.gas += e.gas || 0;
        res.ocExisting += e.ocExisting || 0;
        res.ocNew += e.ocNew || 0;
        res.postpaid += e.postpaid || 0;
        res.adsl += e.adsl || 0;
        res.wireless += e.wireless || 0;
        res.devices += e.devices || 0;
        res.points += e.totalPoints || 0;
      });
      return res;
    }

    function pct(ach, target) {
      if (!target) return 0;
      return (ach / target) * 100;
    }

    function statusBadge(p) {
      if (p >= 110) return '<span class="badge badge-good">' + p.toFixed(0) + '% Over</span>';
      if (p >= 100) return '<span class="badge badge-good">' + p.toFixed(0) + '% Done</span>';
      if (p >= 80) return '<span class="badge badge-mid">' + p.toFixed(0) + '% On track</span>';
      return '<span class="badge badge-bad">' + p.toFixed(0) + '% Low</span>';
    }

    function renderDashboard() {
      const branch = sumEntries(() => true);
      const t = state.targets;
      const branchDiv = $('branchOverview');

      const rows = [
        ['GAs', branch.gas, t.gas],
        ['OC Existing', branch.ocExisting, t.ocExisting],
        ['OC New', branch.ocNew, t.ocNew],
        ['Postpaid', branch.postpaid, t.postpaid],
        ['Home ADSL', branch.adsl, t.adsl],
        ['Home Wireless', branch.wireless, t.wireless],
        ['Devices', branch.devices, t.devices],
        ['Points', branch.points, t.points]
      ];

      let html = '<table class="table"><thead><tr><th>KPI</th><th>Achieved</th><th>Target</th><th>%</th><th>Status</th></tr></thead><tbody>';
      rows.forEach(([name, ach, target]) => {
        const p = pct(ach, target);
        html += '<tr>' +
          '<td>' + name + '</td>' +
          '<td>' + ach.toFixed(1) + '</td>' +
          '<td>' + (target || '-') + '</td>' +
          '<td>' + (target ? p.toFixed(0) + '%' : '-') + '</td>' +
          '<td>' + (target ? statusBadge(p) : '') + '</td>' +
        '</tr>';
      });
      html += '</tbody></table>';
      branchDiv.innerHTML = html;

      // per-user cards
      const wrap = $('userCardsWrapper');
      wrap.innerHTML = '';
      if (!state.users.length) {
        wrap.innerHTML = '<p class="hint">No users yet. Add them from Settings.</p>';
        return;
      }
      state.users.forEach(u => {
        const share = (u.share || 0) / 100;
        const totals = sumEntries(e => e.userId === u.id);
        const userTargets = {
          gas: t.gas * share,
          ocExisting: t.ocExisting * share,
          ocNew: t.ocNew * share,
          postpaid: t.postpaid * share,
          adsl: t.adsl * share,
          wireless: t.wireless * share,
          devices: t.devices * share,
          points: t.points * share
        };
        const list = [
          ['GAs', totals.gas, userTargets.gas],
          ['OC Ex', totals.ocExisting, userTargets.ocExisting],
          ['OC New', totals.ocNew, userTargets.ocNew],
          ['Post', totals.postpaid, userTargets.postpaid],
          ['ADSL', totals.adsl, userTargets.adsl],
          ['HW', totals.wireless, userTargets.wireless],
          ['Dev', totals.devices, userTargets.devices],
          ['Pts', totals.points, userTargets.points]
        ];
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = '<h3>' + u.name + '</h3>' +
          '<div class="sub">Share: ' + (u.share || 0) + '% of branch target</div>';
        let table = '<table class="table"><thead><tr><th>KPI</th><th>Ach</th><th>Target</th><th>%</th></tr></thead><tbody>';
        list.forEach(([name, ach, target]) => {
          const p = pct(ach, target);
          table += '<tr>' +
            '<td>' + name + '</td>' +
            '<td>' + ach.toFixed(1) + '</td>' +
            '<td>' + (target ? target.toFixed(1) : '-') + '</td>' +
            '<td>' + (target ? p.toFixed(0) + '%' : '-') + '</td>' +
          '</tr>';
        });
        table += '</tbody></table>';
        card.innerHTML += table;
        wrap.appendChild(card);
      });
    }

    // ===== INIT =====
    populateUserSelect();
    setToday();
    renderSavedDays();
    renderDashboard();
    renderSettings();
  </script>
</body>
</html>
